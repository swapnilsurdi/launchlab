name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          docker compose config > /dev/null
          echo "✅ docker-compose.yml is valid"

      - name: Validate docker-compose.init.yml
        run: |
          docker compose -f docker-compose.yml -f docker-compose.init.yml config > /dev/null
          echo "✅ docker-compose.init.yml is valid"

      - name: Check for secrets in .env.template
        run: |
          if grep -E "(password|token|key|secret).*=.*[^_]" .env.template | grep -v "changeme" | grep -v "your_" | grep -v "auto_generated" | grep -v "generate_"; then
            echo "❌ Found hardcoded secrets in .env.template"
            exit 1
          else
            echo "✅ No hardcoded secrets in .env.template"
          fi

      - name: Validate shell scripts
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          find scripts -name "*.sh" -type f | while read script; do
            echo "Checking $script..."
            shellcheck "$script" -S warning || true
          done

      - name: Check Python syntax
        run: |
          find scripts -name "*.py" -type f | while read script; do
            echo "Checking $script..."
            python3 -m py_compile "$script"
          done
          echo "✅ All Python scripts are valid"

  test-quicksetup:
    name: Test Quicksetup Wizard
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y apache2-utils

      - name: Test quicksetup (non-interactive)
        env:
          ADMIN_EMAIL: test@example.com
          WG_PASSWORD: TestPassword123
          DUCKDNS_DOMAIN: testdomain
          DUCKDNS_TOKEN: test-token-12345
        run: |
          # Create mock quicksetup for testing
          cat > test-quicksetup.sh << 'EOF'
          #!/bin/bash
          set -e

          # Mock user inputs using environment variables
          ADMIN_EMAIL="${ADMIN_EMAIL:-test@example.com}"
          WG_PASSWORD="${WG_PASSWORD:-TestPassword123}"
          DUCKDNS_DOMAIN="${DUCKDNS_DOMAIN:-testdomain}"
          DUCKDNS_TOKEN="${DUCKDNS_TOKEN:-test-token}"
          TIMEZONE="America/Los_Angeles"
          LOCAL_SUBNET="192.168.1.0/24"

          # Generate passwords and keys
          POSTGRES_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-32)
          REDIS_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-32)
          PAPERLESS_SECRET_KEY=$(openssl rand -hex 32)
          WEBUI_SECRET_KEY=$(openssl rand -hex 32)
          WG_PASSWORD_HASH=$(htpasswd -nbB admin "$WG_PASSWORD" | cut -d: -f2)

          # Create .env file
          cat > .env << ENVEOF
          EMAIL=${ADMIN_EMAIL}
          WG_PASSWORD_HASH=${WG_PASSWORD_HASH}
          DUCKDNS_DOMAIN=${DUCKDNS_DOMAIN}
          DUCKDNS_TOKEN=${DUCKDNS_TOKEN}
          DOMAIN=${DUCKDNS_DOMAIN}.duckdns.org
          TIMEZONE=${TIMEZONE}
          LOCAL_SUBNET=${LOCAL_SUBNET}
          POSTGRES_USER=homelab
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          REDIS_PASSWORD=${REDIS_PASSWORD}
          PORTAINER_ADMIN_PASSWORD=changeme
          JELLYFIN_ADMIN_PASSWORD=changeme
          PAPERLESS_ADMIN_USER=admin
          PAPERLESS_ADMIN_PASSWORD=changeme
          PAPERLESS_ADMIN_EMAIL=${ADMIN_EMAIL}
          PAPERLESS_SECRET_KEY=${PAPERLESS_SECRET_KEY}
          PIHOLE_PASSWORD=changeme
          WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY}
          MATRIX_SERVER_NAME=homelab.local
          MATRIX_ENABLE_FEDERATION=false
          BACKUP_RETENTION_DAYS=7
          BACKUP_RETENTION_WEEKS=4
          BACKUP_RETENTION_MONTHS=12
          ENVEOF

          echo "✅ .env file created"
          EOF

          chmod +x test-quicksetup.sh
          ./test-quicksetup.sh

      - name: Validate generated .env
        run: |
          if [ ! -f .env ]; then
            echo "❌ .env file not created"
            exit 1
          fi

          # Check required variables exist
          grep -q "EMAIL=" .env || (echo "❌ EMAIL missing" && exit 1)
          grep -q "WG_PASSWORD_HASH=" .env || (echo "❌ WG_PASSWORD_HASH missing" && exit 1)
          grep -q "POSTGRES_PASSWORD=" .env || (echo "❌ POSTGRES_PASSWORD missing" && exit 1)
          grep -q "PAPERLESS_SECRET_KEY=" .env || (echo "❌ PAPERLESS_SECRET_KEY missing" && exit 1)

          echo "✅ All required variables present in .env"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true
